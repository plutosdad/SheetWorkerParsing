var ExExp=function(){return parseExpression=function(e,t){function r(e){function t(e,t){return{type:e,text:t[0],match:t}}if(!e)return e;var r;return(r=e.match(/^\s+/))?t("whitespace",r):(r=e.match(/^(abs|ceil|floor|round|max|min)[(]/))?t("function",r):(r=e.match(/^[({]/))?t("opengroup",r):(r=e.match(/^[)}]/))?t("closegroup",r):(r=e.match(/^((\d+(\.\d+)?)|(\.\d+))/))?t("number",r):(r=e.match(/^['"]/))?t("quote",r):(r=e.match(/^((\|\|)|(&&)|(==)|(!=)|(>=)|(<=)|(<<)|(>>)|(\*\*)|[?:|^&=><%!~])/))?t("extoperator",r):(r=e.match(/^[-+*\/td]/))?t("baseoperator",r):(r=e.match(/^\[([^\]]+)\]/))?t("label",r):(r=e.match(/^\${([^'"($}][^}]*)}/))?t("variable",r):(r=e.match(/^\${/),r?t("openvariable",r):{type:"raw",text:e.charAt(0)})}function n(e){return e.tok=r(e.s),e.tok&&(e.s=e.s.substring(e.tok.text.length)),e}function a(e,t){function r(e){return e.replace(/\\n/g,"\n").replace(/\\r/g,"\r").replace(/\\t/g,"	").replace(/\\/g,"")}for(var a=-1,o=a;0==(a-o&1);){if(a=e.s.indexOf(t,a+1),0>a)return;for(o=a-1;o>=0&&"\\"==e.s.charAt(o);)o--}var u=e.s.substring(0,a).split("\\\\").map(r).join("\\");return e.s=e.s.substring(a),n(e),u}function o(){var e=y.pop(),t=b.pop();if(e.unary)return void b.push({type:"baseoperator"==e.type?"unop":"unopex",datatype:t.datatype,operator:e.text,operand:t});var r=b.pop();if(":"!=e.text){var n;return"d"==e.text||"t"==e.text?n="number":r.datatype==t.datatype?n=r.datatype:("string"==r.datatype||"string"==t.datatype)&&(n="string"),void b.push({type:"baseoperator"==e.type?"binop":"binopex",datatype:n,operator:e.text,left:r,right:t,mods:e.mods,label:e.label})}if(e=y.pop(),"?"!=e.text)return"Error: Expected ? but got "+e.text;var a=b.pop();b.push({type:"cond",cond:a,left:r,right:t,datatype:r.datatype==t.datatype?r.datatype:void 0})}function u(e){var t;for(e.precedence=(e.unary?c[e.text]:f[e.text])||0;y[y.length-1].precedence>=e.precedence;)if(t=o())return t;y.push(e)}function i(e){return","==e||")"==e}function s(){var t;if(n(e),!e.tok)return"Error: Unrecognized token: "+e.s.split(" ",1)[0];for(;"whitespace"==e.tok.type;)if(n(e),!e.tok)return"Error: Unrecognized token: "+e.s.split(" ",1)[0];switch(e.tok.type){case"function":var r,o,p=e.tok.match[1],f=l[p];if("number"==typeof f)r=f,o=f;else{if(typeof f!=typeof[])return"Error: Unrecognized function: "+p;r=f[0],o=f[1]}for(var y=[];e.tok&&")"!=e.tok.text;){var g=parseExpression(e,i);if("string"==typeof g)return g;if(y.push(g),!e.tok)return"Error: Unterminated function: "+p;if(!i(e.tok.text))return"Error: Expected ',' or ')' to continue/close '"+p+"(', but got '"+e.tok.text+"'"}return("number"!=typeof r||0>r)&&(r=y.length),("number"!=typeof o||0>o)&&(o=y.length),y.length<r?"Error: Function '"+p+"' requires at least "+r+" argument(s)":y.length>o?"Error: Function '"+p+"' requires at most "+o+" argument(s)":void b.push({type:"function",datatype:"number","function":p,args:y});case"number":return void b.push({type:"number",datatype:"number",value:parseFloat(e.tok.text)});case"variable":return void b.push({type:"variable",value:e.tok.match[1]});case"quote":var v=a(e,e.tok.text);return"string"!=typeof v?"Error: Unterminated string":void b.push({type:"string",datatype:"string",value:v});case"opengroup":var h=e.tok.text,m=d[h],x=parseExpression(e,m);if("string"==typeof x)return x;if(b.push(x),e.tok.text!=m)return"Error: Expected '"+m+"' to close '"+h+"', but got '"+e.tok.text+"'";return;case"openvariable":var k=parseExpression(e,"}");return"string"==typeof k?k:"}"!=e.tok.text?"Error: Expected '}' to close '${', but got '"+e.tok.text+"'":void b.push({type:"variable",value:k});case"extoperator":case"baseoperator":return c[e.tok.text]?(e.tok.unary=!0,t=u(e.tok),t?t:s()):"Error: "+e.tok.text+" is not a unary operator"}return"Error: Unrecognized token: "+e.tok.text+("raw"==e.tok.type?e.s.split(" ",1)[0]:"")}var p="function"==typeof t?t:function(e){return e==t},l={abs:1,ceil:1,floor:1,round:1,max:[1],min:[1]},f={"?":1,":":2,"||":3,"&&":4,"|":5,"^":6,"&":7,"=":8,"==":8,"!=":8,">=":9,">":9,"<":9,"<=":9,"<<":10,">>":10,"+":11,"-":11,"*":12,"/":12,"%":12,"**":14,t:98,d:99},c={"!":13,"~":13,"-":13},d={"(":")","{":"}"},y=[{precedence:0}],b=[];"string"==typeof e&&(e={s:e});var g=s();if(g)return g;for(n(e);e.tok&&!p(e.tok.text)&&(t||"raw"!=e.tok.type);n(e))switch(e.tok.type){case"extoperator":case"baseoperator":if(rollOperator="d"==e.tok.text?e.tok:null,g=u(e.tok))return g;if(rollOperator&&"F"==e.s.charAt(0))b.push({type:"rollspec",value:"F"}),e.s=e.s.substring(1);else if("t"==e.tok.text){if("["!=e.s.charAt(0))return"Error: 't' operator requires '[table]' argument";var v,h=e.s.match(/^\[([^'"$(\]][^\]]*)\]/);if(h)v=h[1],e.s=e.s.substring(h[0].length);else{if(e.s=e.s.substring(1),v=parseExpression(e,"]"),"string"==typeof v)return v;if("]"!=e.tok.text)return"Error: Expected ']' to close 't[', but got '"+e.tok.text+"'"}b.push({type:"tablename",value:v})}else if(g=s())return g;if(rollOperator){var h=e.s.match(/^[acdfhkloprs0-9<=>!]+/);h&&(rollOperator.mods=h[0],e.s=e.s.substring(h[0].length))}break;case"label":if(y.length>0&&"d"==y[y.length-1].text){y[y.length-1].label=e.tok.match[1];break}var m=b.pop();m&&(m.label=e.tok.match[1],b.push(m))}for(;y.length>1;)if(g=o())return g;return b.pop()},write=function(e){console.log("EXEXP:"+e)},sendCommand=function(e,t,r,n){function a(e,t,r,n,o,u){var i,s;switch(e.label&&(t[e.label]=e),e.type){case"number":case"rollspec":e.baseValid=!0;case"string":return e;case"tablename":if("string"!=typeof e.value){if(i=a(e.value,t,r,n,o,!0),"string"==typeof i)return i;if("number"==i.type&&(i.value=""+i.value,i.type="string"),"string"!=i.type)return e.baseValid&&(e.baseValid=!1),n.push(e.value),e;e.value=i.value}return e.baseValid=!0,e;case"function":for(var c=[],d=0;d<e.args.length;d++){if(i=a(e.args[d],t,r,n,o,!0),"string"==typeof i)return i;if("string"==i.type&&(i.value=parseFloat(i.value),i.type="number"),"number"!=i.type)return e.baseValid&&(e.baseValid=!1),e;c.push(i.value)}e.type="number",e.datatype="number",e.value=p[e["function"]].apply(c,c);for(var d=0;d<e.args.length;d++)e.args[d].label&&(t[e.args[d].label]=e.args[d]);return delete e["function"],delete e.args,e.baseValid=!0,e;case"unop":case"unopex":if(u=u||"unop"!=e.type,i=a(e.operand,t,r,n,o,u),"string"==typeof i)return i;if(u){if("number"!=i.type)return e.baseValid&&(e.baseValid=!1),e;e.type="number",e.datatype="number",e.value=f[e.operator](i.value),delete e.operator,e.operand.label&&(t[e.operand.label]=i),delete e.operand,e.baseValid=!0}else e.baseValid=i.baseValid;return e;case"binop":case"binopex":u=u||"binop"!=e.type||"string"==e.left.datatype||"string"==e.right.datatype;var y=u||"d"==e.operator||"t"==e.operator;if(i=a(e.left,t,r,n,o,y),s=a(e.right,t,r,n,o,y),u=!0){if("number"!=i.type&&"string"!=i.type)return e.baseValid&&(e.baseValid=!1),e;if("number"!=s.type&&"string"!=s.type&&"rollspec"!=s.type&&"tablename"!=s.type)return e.baseValid&&(e.baseValid=!1),e;if("rollspec"==s.type&&"d"!=e.operator)return"Rollspec operand is only compatible with 'd' operator";if("t"==e.operator&&"tablename"!=s.type)return"'t' operator requires tablename operand";if("t"==e.operator||"d"==e.operator&&e.mods)return o.push(e),e;e.value=l[e.operator](i.value,s.value),delete e.operator,e.left.label&&(t[e.left.label]=i),delete e.left,e.right.label&&(t[e.right.label]=s),delete e.right,e.type="string"==typeof e.value?"string":"number",e.datatype=e.type,e.baseValid="number"==e.datatype}else"number"==i.datatype&&"number"==s.datatype&&(e.datatype="number",e.baseValid=!0);return e;case"cond":if(i=a(e.cond,t,r,n,o,!0),"string"==typeof i)return i;if("number"!=i.type&&"string"!=i.type)return e.baseValid=!1,e;s=i.value?e.left:e.right,e.cond.label&&(t[e.cond.label]=i),delete e.cond,delete e.left,delete e.right;for(var b in s)e[b]=s[b];return a(e,t,r,n,o,u);case"variable":if("string"!=typeof e.value){if(i=a(e.value,t,r,n,o,!0),"string"==typeof i)return i;if("number"==i.type&&(i.value=""+i.value,i.type="string"),"string"!=i.type)return e.baseValid&&(e.baseValid=!1),n.push(e.value),e;e.value=i.value}return!t[e.value]||"string"!=t[e.value].type&&"number"!=t[e.value].type?(r[e.value]||(r[e.value]=[]),r[e.value].push(e),e.baseValid&&(e.baseValid=!1)):(e.type=t[e.value].type,e.datatype=t[e.value].datatype,e.baseValid=t[e.value].baseValid,e.value=t[e.value].value),e;default:return"Unknown node type: "+e.type}}function o(e){if("number"==e.type||"string"==e.type||"rollspec"==e.type)return!1;if(e.label)return!0;switch(e.type){case"function":for(var t=0;t<e.args.length;t++)if(o(e.args[t]))return!0;return!1;case"tablename":case"variable":return"string"==typeof e.value?!1:o(e.value);case"unop":case"unopex":return o(e.operand);case"cond":if(o(e.cond))return!0;case"binop":case"binopex":return o(e.left)?!0:o(e.right)}}function u(e){var t;switch(e.type){case"number":case"rollspec":t=e.value||0;break;case"tablename":t="["+e.value+"]";break;case"unop":t="("+e.operator+u(e.operand)+")";break;case"binop":t="("+u(e.left)+e.operator+u(e.right)+(e.mods||"")+")",e.label&&"d"==e.operator&&(t+="["+e.label+"]");break;default:return"Unknown node type: "+e.type}return t}function i(e){if("string"==e.type)return e.value;var t=u(e);return t}function s(e){return ExExp.write("Error: "+e),""}for(var p={abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,max:Math.max,min:Math.min},l={"||":function(e,t){return e||t},"&&":function(e,t){return e&&t},"|":function(e,t){return e|t},"^":function(e,t){return e^t},"&":function(e,t){return e&t},"=":function(e,t){return e==t},"==":function(e,t){return e==t},"!=":function(e,t){return e!=t},">=":function(e,t){return e>=t},">":function(e,t){return e>t},"<":function(e,t){return t>e},"<=":function(e,t){return t>=e},"<<":function(e,t){return e<<t},">>":function(e,t){return e>>t},"+":function(e,t){return e+t},"-":function(e,t){return e-t},"*":function(e,t){return e*t},"/":function(e,t){return e/t},"%":function(e,t){return e%t},"**":Math.pow,d:function(e,t){for(var r=0,n=0;e>n;n++)r+=randomInteger(t);return r}},f={"!":function(e){return!e},"~":function(e){return~e},"-":function(e){return-e}},c={},d=[],y=[],b=0;b<r.length;b++){var g=r[b][0];delete g.operator,delete g.left,delete g.right,g.type="number",g.datatype="number",g.value=r[b][1],g.baseValid=!0}for(var b=0;b<t.length;b++)if(!t[b].baseValid&&"string"!=t[b].type&&"number"!=t[b].type){var v=a(t[b],n,c,d,y,!1);if("string"==typeof v)return s(v)}for(var h=!0;h;){h=!1;for(var m in c){if(!n[m])return s("Variable '"+m+"' not defined");if("string"!=n[m].type&&"number"!=n[m].type){var v=a(n[m],n,c,d,y,!0);if("string"==typeof v)return s(v)}if("string"==n[m].type||"number"==n[m].type){for(var b=0;b<c[m].length;b++)c[m][b].type=n[m].type,c[m][b].datatype=n[m].datatype,c[m][b].value=n[m].value,c[m][b].baseValid=n[m].baseValid;delete c[m],h=!0}}for(var x=[];d.length>0;){var k=a(d.shift(),n,c,d,y,!0);if("string"==typeof k)return s(v);"string"==k.type||"number"==k.type?h=!0:x.push(k)}d=x}for(var b=t.length-1;b>=0;b--)(t[b].baseValid||"number"==t[b].type||"string"==t[b].type)&&(d.length>0&o(t[b])||e.splice(b,2,(e[b]||"")+i(t.splice(b,1)[0])+(e[b+1]||"")));if(y.length>0)return void Console.log("Cannot evalutate");if(t.length>0)return ExExp.sendCommand(e,t,[],n);var E=e.join("");return E},handleExpression=function(e){var t=[],r=[],n=e.replace(/^\s+/,""),a={s:n},o=ExExp.parseExpression(a,null);return"string"==typeof o?(ExExp.write("could not parse"+e),""):(r.push(o),a.s=a.tok?a.tok.text+a.s:a.s,t.push(a.s),ExExp.sendCommand(t,r,[],{}))},{parseExpression:parseExpression,write:write,sendCommand:sendCommand,handleExpression:handleExpression}}(),SWUtils=SWUtils||function(){var e=function(e){var t=e.match(/\||\?|&|\{|\}|k[h,l][^1]/);if(void 0!=t&&t.length>0)return!1;var r=e.replace(/floor|ceil|round|abs|max|min|kh1|kl1/g,"");return t=r.match(/[a-zA-Z]/),void 0!=t&&t.length>0?!1:!0},t=function(t,r,n){if("function"==typeof n){if(!t)return void n("");try{var a,o,u=[],i=[];if(r&&(t=t.replace("selected|","").replace("target|","")),i=t.match(/(@\{([^}]+)\})(?!.*\1)/g),"undefined"==typeof i||null==i)return void n(t);for(o=i.length,u=[o],a=0;o>a;a++)u[a]=i[a].replace("@{","").replace("}","");getAttrs(u,function(s){var p=t;try{var l=[o];for(a=0;o>a;a++)l[a]=s[u[a]];for(a=0;o>a;a++)p=p.split(i[a]).join(l[a]);r&&(p=p.replace(/\s+/g,"").replace(/\[\[/g,"(").replace(/\]\]/g,")"),e(p)||(p="",console.log("ERROR: cannot evaluate this to number: "+t)))}catch(f){console.log("ERROR:"+f),p=""}finally{n(p)}})}catch(s){console.log("ERROR: "+s),n(t)}}},r=function(e,r){"function"==typeof r&&(e||r(""),t(e,!0,function(e){var t;"undefined"!=typeof e&&null!=e?(t=ExExp.handleExpression(e),r(t)):r("")}))},n=function(e,r,n){"undefined"!=typeof r&&null!=r&&"undefined"!=typeof e&&null!=e&&getAttrs([e],n,function(n){t(n[e],function(e){if("undefined"!=typeof e&&null!=e&&e.length>0){var t={};t[r]=e,setAttrs(t)}})})},a=function(e,t,r){getAttrs([e,t],function(n){var a={},o=0,u=parseFloat(n[t],10)||0;o=parseFloat(n[e]),isNaN(o)||"undefined"==typeof o?SWUtils.evaluateExpression(n[e],function(e){(isNaN(e)||"undefined"==typeof e)&&(e=r||0),u!==e&&(a[t]=e,setAttrs(a))}):u!==o&&(a[t]=o,setAttrs(a))})};return{validNumericStr:e,searchAndReplaceFields:t,evaluateExpression:r,evaluateAndSetString:n,evaluateAndSetNumber:a}}();
